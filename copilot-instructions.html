<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Copilot instructions for opal • opal</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="deps/Fira_Code-0.4.10/font.css" rel="stylesheet"><link href="deps/Montserrat-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Copilot instructions for opal"><meta property="og:image" content="https://n-ducharmebarth-noaa.github.io/opal/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">opal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/bet.html">The BET model</a></li>
    <li><a class="dropdown-item" href="articles/quickstart.html">Quickstart Guide</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/N-DucharmeBarth-NOAA/opal" aria-label="GitHub"><span class="fa fab fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/N-DucharmeBarth-NOAA/opal/issues" aria-label="Report an issue"><span class="fa fas fa-bug"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>Copilot instructions for opal</h1>

    </div>

<div id="copilot-instructions-for-opal" class="section level1">

<p>Purpose: help AI coding agents be immediately productive working on the <strong>opal</strong> R package — the <strong>o</strong>pen <strong>p</strong>opulation <strong>a</strong>ssessment <strong>l</strong>ibrary for fisheries stock assessment.</p>
<div class="section level2">
<h2 id="big-picture">Big picture<a class="anchor" aria-label="anchor" href="#big-picture"></a></h2>
<p><code>opal</code> is an R package that implements age- and season-structured population dynamics models for fisheries stock assessment. It is built on <a href="https://github.com/kaskr/RTMB" class="external-link">RTMB</a> for automatic differentiation, enabling gradient-based optimization (<code>nlminb</code>) and MCMC sampling (<code>SparseNUTS</code>). The primary application is WCPO bigeye tuna (BET), but the design is general.</p>
</div>
<div class="section level2">
<h2 id="repo-layout">Repo layout<a class="anchor" aria-label="anchor" href="#repo-layout"></a></h2>
<table class="table"><colgroup><col width="37%"><col width="62%"></colgroup><thead><tr class="header"><th>Path</th>
<th>Contents</th>
</tr></thead><tbody><tr class="odd"><td><code>R/</code></td>
<td>All package source code (23 files). Core logic lives here.</td>
</tr><tr class="even"><td><code>man/</code></td>
<td>roxygen2-generated <code>.Rd</code> help files. <strong>Do not edit by hand.</strong>
</td>
</tr><tr class="odd"><td><code>data/</code></td>
<td>Bundled <code>.rda</code> datasets (<code>wcpo_bet_data</code>, <code>wcpo_bet_lf</code>, <code>wcpo_bet_wf</code>, <code>wcpo_bet_parameters</code>)</td>
</tr><tr class="even"><td><code>tests/testthat/</code></td>
<td>
<code>testthat</code> edition 3 test suite</td>
</tr><tr class="odd"><td><code>vignettes/</code></td>
<td>
<code>quickstart.Rmd</code> (overview) and <code>bet.Rmd</code> (full worked example)</td>
</tr><tr class="even"><td><code>renv/</code></td>
<td>
<code>renv</code> lockfile and library for reproducible dependencies</td>
</tr><tr class="odd"><td><code>.github/workflows/</code></td>
<td>CI: R-CMD-check, pkgdown deploy, roxygen2, Rmd rendering</td>
</tr><tr class="even"><td>
<code>DESCRIPTION</code>, <code>NAMESPACE</code>
</td>
<td>Standard R package metadata (roxygen2-managed)</td>
</tr></tbody></table></div>
<div class="section level2">
<h2 id="where-to-start">Where to start<a class="anchor" aria-label="anchor" href="#where-to-start"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>README.md</strong> — package overview and installation</li>
<li>
<strong><code>vignettes/bet.Rmd</code></strong> — full worked tutorial: data prep → model fitting → diagnostics → plots</li>
<li>
<strong><code>R/model.R</code></strong> (<code><a href="reference/opal_model.html">opal_model()</a></code>) — the central model function that orchestrates all components</li>
<li>
<strong><code>R/dynamics.R</code></strong> (<code><a href="reference/do_dynamics.html">do_dynamics()</a></code>) — age-season forward population simulation</li>
<li>
<strong><code>R/likelihoods.R</code></strong> — CPUE, length-composition, and weight-composition likelihood components</li>
</ol></div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="model-function-opal_modelparameters-data">Model function: <code>opal_model(parameters, data)</code>
<a class="anchor" aria-label="anchor" href="#model-function-opal_modelparameters-data"></a></h3>
<p>The core function in <code>R/model.R</code>. It is an RTMB-compatible closure that: 1. Unpacks data + parameters via <code>getAll(data, parameters)</code> 2. Runs modular steps in sequence: growth → PLA → weight-at-age → biology → selectivity → initial numbers → dynamics → priors → likelihoods 3. Aggregates NLL: <code>nll = lp_prior + lp_rec + sum(lp_cpue) + sum(lp_lf) + sum(lp_wf)</code> 4. Reports derived quantities via <code>REPORT()</code> (spawning biomass, numbers-at-age, etc.)</p>
<p>Usage: <code>RTMB::MakeADFun(func = cmb(opal_model, data), parameters = params, map = map)</code> where <code>cmb(f, d)</code> creates <code>function(p) f(p, d)</code>.</p>
</div>
<div class="section level3">
<h3 id="key-components-each-is-an-exported-function-in-r">Key components (each is an exported function in <code>R/</code>)<a class="anchor" aria-label="anchor" href="#key-components-each-is-an-exported-function-in-r"></a></h3>
<table class="table"><colgroup><col width="45%"><col width="27%"><col width="27%"></colgroup><thead><tr class="header"><th>Function</th>
<th>File</th>
<th>Role</th>
</tr></thead><tbody><tr class="odd"><td>
<code><a href="reference/get_growth.html">get_growth()</a></code>, <code><a href="reference/get_sd_at_age.html">get_sd_at_age()</a></code>
</td>
<td><code>growth.R</code></td>
<td>Schnute VB growth + SD-at-age</td>
</tr><tr class="even"><td><code><a href="reference/get_pla.html">get_pla()</a></code></td>
<td><code>growth.R</code></td>
<td>Probability-of-length-at-age matrix (age-length key)</td>
</tr><tr class="odd"><td><code><a href="reference/get_selectivity.html">get_selectivity()</a></code></td>
<td><code>selectivity.R</code></td>
<td>Logistic or double-normal selectivity (length-based → age via PLA)</td>
</tr><tr class="even"><td><code><a href="reference/get_initial_numbers.html">get_initial_numbers()</a></code></td>
<td><code>dynamics.R</code></td>
<td>Equilibrium N-at-age, R0, BH alpha/beta</td>
</tr><tr class="odd"><td><code><a href="reference/do_dynamics.html">do_dynamics()</a></code></td>
<td><code>dynamics.R</code></td>
<td>Forward age-season simulation with Baranov catch equation</td>
</tr><tr class="even"><td><code><a href="reference/get_harvest_rate.html">get_harvest_rate()</a></code></td>
<td><code>dynamics.R</code></td>
<td>Per-fishery harvest rates with <code>posfun</code> penalty</td>
</tr><tr class="odd"><td><code><a href="reference/get_recruitment.html">get_recruitment()</a></code></td>
<td><code>recruitment.R</code></td>
<td>Beverton-Holt SRR with log-normal deviations</td>
</tr><tr class="even"><td><code><a href="reference/get_cpue_like.html">get_cpue_like()</a></code></td>
<td><code>likelihoods.R</code></td>
<td>Log-normal CPUE likelihood</td>
</tr><tr class="odd"><td><code><a href="reference/get_length_like.html">get_length_like()</a></code></td>
<td><code>likelihoods.R</code></td>
<td>Multinomial / Dirichlet / Dirichlet-multinomial LF likelihood</td>
</tr><tr class="even"><td><code><a href="reference/get_weight_like.html">get_weight_like()</a></code></td>
<td><code>likelihoods.R</code></td>
<td>Same three options for weight compositions</td>
</tr><tr class="odd"><td>
<code><a href="reference/get_M.html">get_M()</a></code>, <code><a href="reference/get_M_length.html">get_M_length()</a></code>
</td>
<td><code>natural-mortality.R</code></td>
<td>Piecewise or Lorenzen natural mortality</td>
</tr><tr class="even"><td><code><a href="reference/evaluate_priors.html">evaluate_priors()</a></code></td>
<td><code>priors.R</code></td>
<td>Prior evaluation (normal, lognormal, beta, t)</td>
</tr><tr class="odd"><td><code><a href="reference/get_parameters.html">get_parameters()</a></code></td>
<td><code>parameters.R</code></td>
<td>Default parameter list</td>
</tr><tr class="even"><td><code><a href="reference/get_map.html">get_map()</a></code></td>
<td><code>parameters.R</code></td>
<td>Default map (which params to fix)</td>
</tr><tr class="odd"><td><code><a href="reference/get_bounds.html">get_bounds()</a></code></td>
<td><code>parameters.R</code></td>
<td>Optimization bounds for <code>nlminb</code>
</td>
</tr><tr class="even"><td><code><a href="reference/get_data.html">get_data()</a></code></td>
<td><code>get-data.R</code></td>
<td>Legacy data builder (BET-specific)</td>
</tr><tr class="odd"><td><code><a href="reference/prep_lf_data.html">prep_lf_data()</a></code></td>
<td><code>prep-lf.R</code></td>
<td>Prepare length-frequency data for model</td>
</tr><tr class="even"><td><code><a href="reference/prep_wf_data.html">prep_wf_data()</a></code></td>
<td><code>prep-wf.R</code></td>
<td>Prepare weight-frequency data for model</td>
</tr><tr class="odd"><td><code><a href="reference/run_grid.html">run_grid()</a></code></td>
<td><code>grid.R</code></td>
<td>Grid-based sensitivity analysis (parallel optimization)</td>
</tr><tr class="even"><td><code><a href="reference/sample_grid.html">sample_grid()</a></code></td>
<td><code>grid.R</code></td>
<td>Sample grid cells proportional to likelihood for integrated uncertainty</td>
</tr><tr class="odd"><td><code><a href="reference/get_posterior.html">get_posterior()</a></code></td>
<td><code>get-posterior.R</code></td>
<td>Extract derived quantities from MCMC draws</td>
</tr><tr class="even"><td><code><a href="reference/project_dynamics.html">project_dynamics()</a></code></td>
<td><code>projections.R</code></td>
<td>Forward projections from posterior</td>
</tr><tr class="odd"><td><code><a href="reference/opalprofile.html">opalprofile()</a></code></td>
<td><code>profile.R</code></td>
<td>1D likelihood profiling</td>
</tr><tr class="even"><td><code>plot_*()</code></td>
<td><code>plots.R</code></td>
<td>ggplot2 visualization functions</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="typical-workflow-from-vignettesbetrmd">Typical workflow (from <code>vignettes/bet.Rmd</code>)<a class="anchor" aria-label="anchor" href="#typical-workflow-from-vignettesbetrmd"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://n-ducharmebarth-noaa.github.io/opal/">opal</a></span><span class="op">)</span></span>
<span><span class="va">data</span>    <span class="op">&lt;-</span> <span class="va">wcpo_bet_data</span></span>
<span><span class="va">lf</span>      <span class="op">&lt;-</span> <span class="va">wcpo_bet_lf</span></span>
<span><span class="va">params</span>  <span class="op">&lt;-</span> <span class="va">wcpo_bet_parameters</span></span>
<span></span>
<span><span class="co"># Prepare composition data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/prep_lf_data.html">prep_lf_data</a></span><span class="op">(</span><span class="va">data</span>, lf_wide <span class="op">=</span> <span class="fu">pivot_wider</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Configure</span></span>
<span><span class="va">params</span>  <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_parameters.html">get_parameters</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">priors</span>  <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_priors.html">get_priors</a></span><span class="op">(</span><span class="va">params</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">map</span>     <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_map.html">get_map</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="va">bounds</span>  <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_bounds.html">get_bounds</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build AD object</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span>func <span class="op">=</span> <span class="fu"><a href="reference/cmb.html">cmb</a></span><span class="op">(</span><span class="va">opal_model</span>, <span class="va">data</span><span class="op">)</span>, parameters <span class="op">=</span> <span class="va">params</span>, map <span class="op">=</span> <span class="va">map</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optimize (double run for convergence)</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj</span><span class="op">$</span><span class="va">gr</span>, lower <span class="op">=</span> <span class="va">bounds</span><span class="op">$</span><span class="va">lower</span>, upper <span class="op">=</span> <span class="va">bounds</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj</span><span class="op">$</span><span class="va">gr</span>, lower <span class="op">=</span> <span class="va">bounds</span><span class="op">$</span><span class="va">lower</span>, upper <span class="op">=</span> <span class="va">bounds</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Diagnostics</span></span>
<span><span class="fu"><a href="reference/check_estimability.html">check_estimability</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/get_cor_pairs.html">get_cor_pairs</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="fu">sdreport</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize</span></span>
<span><span class="va">rep</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/plot_lf.html">plot_lf</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">rep</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/plot_cpue.html">plot_cpue</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">rep</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/plot_biomass_spawning.html">plot_biomass_spawning</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">rep</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="ad-safe-coding-patterns">AD-safe coding patterns<a class="anchor" aria-label="anchor" href="#ad-safe-coding-patterns"></a></h2>
<p>These patterns are <strong>critical</strong> — breaking them will cause silent errors or tape corruption:</p>
<ul><li>
<strong><code>ADoverload</code> at function top</strong>: Every function touching AD values must call <code>"[&lt;-" &lt;- ADoverload("[&lt;-")</code> (and sometimes <code>"c" &lt;- ADoverload("c")</code>) before any array subset-assignment.</li>
<li>
<strong><code>getAll()</code> unpacking</strong>: Both <code><a href="reference/opal_model.html">opal_model()</a></code> and <code><a href="reference/do_dynamics.html">do_dynamics()</a></code> use <code>getAll(data, parameters, warn = FALSE)</code> to unpack list elements into local scope.</li>
<li>
<strong><code>REPORT()</code> / <code>OBS()</code></strong>: RTMB’s mechanisms for reporting derived quantities and marking simulation-capable observations.</li>
<li>
<strong>PLA as the bridge</strong>: The probability-of-length-at-age matrix connects age-based dynamics to length-based observations and selectivity. It sits on the AD tape when growth parameters are estimated.</li>
<li>
<strong>Flat vector storage</strong>: Length/weight composition observations are stored as flat vectors (<code>lf_obs_flat</code>, <code>lf_obs_ints</code>, <code>lf_obs_prop</code>) rather than ragged lists, for RTMB compatibility.</li>
</ul></div>
<div class="section level2">
<h2 id="parameter-structure">Parameter structure<a class="anchor" aria-label="anchor" href="#parameter-structure"></a></h2>
<p>Key parameters returned by <code>get_parameters(data)</code>:</p>
<table class="table"><colgroup><col width="45%"><col width="54%"></colgroup><thead><tr class="header"><th>Parameter</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td><code>log_B0</code></td>
<td>Log unfished spawning biomass</td>
</tr><tr class="even"><td><code>log_h</code></td>
<td>Log steepness (BH SRR)</td>
</tr><tr class="odd"><td><code>log_sigma_r</code></td>
<td>Log recruitment SD</td>
</tr><tr class="even"><td>
<code>log_cpue_q</code>, <code>cpue_creep</code>, <code>log_cpue_tau</code>, <code>log_cpue_omega</code>
</td>
<td>CPUE observation model</td>
</tr><tr class="odd"><td>
<code>log_L1</code>, <code>log_L2</code>, <code>log_k</code>
</td>
<td>Growth (Schnute VB)</td>
</tr><tr class="even"><td>
<code>log_CV1</code>, <code>log_CV2</code>
</td>
<td>Growth variability</td>
</tr><tr class="odd"><td><code>par_sel</code></td>
<td>Selectivity matrix <code>[n_fishery, 6]</code>
</td>
</tr><tr class="even"><td><code>log_lf_tau</code></td>
<td>LF variance adjustment per fishery</td>
</tr><tr class="odd"><td><code>log_wf_tau</code></td>
<td>WF variance adjustment per fishery</td>
</tr><tr class="even"><td><code>rdev_y</code></td>
<td>Annual recruitment deviations</td>
</tr></tbody></table><p>All log-transformed for unconstrained optimization. <code><a href="reference/get_map.html">get_map()</a></code> fixes many by default (steepness, sigma_r, growth, CPUE creep/sigma/omega).</p>
</div>
<div class="section level2">
<h2 id="data-structure">Data structure<a class="anchor" aria-label="anchor" href="#data-structure"></a></h2>
<p>The <code>data</code> list contains 25+ elements defining the model dimensions and observations:</p>
<ul><li>Dimensions: <code>n_year</code>, <code>n_season</code>, <code>n_age</code>, <code>n_fishery</code>, <code>n_len</code>
</li>
<li>Observations: <code>catch_obs_ysf</code>, <code>cpue_*</code>, <code>lf_*</code>, <code>wf_*</code>
</li>
<li>Biology: <code>M_a</code> or M parameters, <code>maturity_at_length</code>, <code>lw_a</code>, <code>lw_b</code>
</li>
<li>Switches: <code>lf_switch</code> (1=multinomial, 2=Dirichlet, 3=DM), <code>wf_switch</code> (0=off, or 1/2/3)</li>
<li>Array naming convention uses dimension suffixes: <code>_ysf</code> (year-season-fishery), <code>_fya</code> (fishery-year-age), <code>_ysa</code> (year-season-age)</li>
</ul><p>Composition data is prepared via <code><a href="reference/prep_lf_data.html">prep_lf_data()</a></code> and <code><a href="reference/prep_wf_data.html">prep_wf_data()</a></code>, which convert wide-format data frames to the flat vector format the model expects.</p>
</div>
<div class="section level2">
<h2 id="environment--development">Environment &amp; development<a class="anchor" aria-label="anchor" href="#environment--development"></a></h2>
<ul><li>
<strong>R packages</strong> are managed with <code>renv/</code>. Run <code><a href="https://rstudio.github.io/renv/reference/activate.html" class="external-link">renv::activate()</a></code> then <code><a href="https://rstudio.github.io/renv/reference/restore.html" class="external-link">renv::restore()</a></code> to set up.</li>
<li>
<strong>Key dependencies</strong>: <code>RTMB</code>, <code>RTMBdist</code>, <code>SparseNUTS</code>, <code>ggplot2</code>, <code>dplyr</code>, <code>tidyr</code>, <code>foreach</code>, <code>doParallel</code>, <code>loo</code>, <code>rstan</code>, <code>forecast</code>, <code>mgcv</code>
</li>
<li>
<strong>Documentation</strong>: roxygen2-based. After editing <code>R/*.R</code> files, regenerate with <code>devtools::document()</code>.</li>
<li>
<strong>Tests</strong>: <code>testthat</code> edition 3. Run with <code>devtools::test()</code>. Tests cover dynamics, growth, all three likelihood types, selectivity, data prep, rebinning, and utilities.</li>
<li>
<strong>CI</strong>: GitHub Actions run <code>R CMD check</code>, pkgdown site builds, roxygen2 re-generation, and Rmd rendering.</li>
<li>
<strong>Branch workflow</strong>: PRs go against <code>dev</code>; <code>main</code> is the stable release branch.</li>
</ul></div>
<div class="section level2">
<h2 id="debugging-tips">Debugging tips<a class="anchor" aria-label="anchor" href="#debugging-tips"></a></h2>
<ul><li>Run <code>check_estimability(obj)</code> after fitting to detect non-identifiable parameters via Hessian eigenvalue analysis.</li>
<li>Run <code>get_cor_pairs(obj, threshold = 0.95)</code> to find highly correlated parameter pairs.</li>
<li>Use <code><a href="reference/get_par_table.html">get_par_table()</a></code> to review initial vs estimated values, gradients, and bounds proximity.</li>
<li>Use <code>obj$simulate()</code> with RTMB’s <code>OBS()</code> mechanism for simulation-based diagnostics.</li>
<li>If optimization fails, try <code><a href="reference/run_grid.html">run_grid()</a></code> which does triple <code>nlminb</code> restarts for robustness.</li>
</ul></div>
<div class="section level2">
<h2 id="ai-edit-guidance">AI edit guidance<a class="anchor" aria-label="anchor" href="#ai-edit-guidance"></a></h2>
<ul><li>
<strong>AD safety first</strong>: When adding or modifying any function that receives AD values, include <code>ADoverload("[&lt;-")</code> at the top. Test that <code>obj$fn(obj$par)</code> returns a finite value after changes.</li>
<li>
<strong>Preserve exported API signatures</strong>: All exported functions are documented in <code>man/</code> and used in vignettes. Changing signatures requires updating roxygen docs, NAMESPACE, and vignettes.</li>
<li>
<strong>Run tests after changes</strong>: <code>devtools::test()</code> covers the core components. If adding new functionality, add corresponding tests in <code>tests/testthat/</code>.</li>
<li>
<strong>Regenerate docs</strong>: After editing roxygen comments in <code>R/</code> files, run <code>devtools::document()</code> to update <code>man/</code> and <code>NAMESPACE</code>.</li>
<li>
<strong>Keep patches minimal</strong>: Modify one <code>R/</code> file at a time, run <code>devtools::test()</code> and <code>devtools::check()</code> to validate.</li>
<li>
<strong>Composition data flow</strong>: When modifying likelihood functions, understand the full pipeline: raw data → <code><a href="reference/prep_lf_data.html">prep_lf_data()</a></code>/<code><a href="reference/prep_wf_data.html">prep_wf_data()</a></code> → flat vectors → likelihood function. The <code>lf_switch</code>/<code>wf_switch</code> controls which distribution is used.</li>
<li>
<strong>Selectivity changes</strong>: When modifying selectivity, update <code>par_sel</code> dimensions, <code><a href="reference/get_map.html">get_map()</a></code> (which elements are fixed), and <code><a href="reference/get_bounds.html">get_bounds()</a></code> simultaneously.</li>
<li>
<strong>Grid/sensitivity</strong>: <code><a href="reference/get_grid.html">get_grid()</a></code> creates parameter combinations; <code><a href="reference/run_grid.html">run_grid()</a></code> optimizes each. Changes to the parameter or data structure must be reflected in both.</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Darcy Webber, Philipp Neubauer, Nicholas Ducharme-Barth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

